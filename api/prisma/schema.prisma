// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core types

model User {
  id               String    @id @default(uuid())
  // discordId        String    @unique
  walletAddress    String?
  stakeKeyLovelace Float?
  jwt              String?
  createdAt        DateTime? @default(now())
  updatedAt        DateTime? @updatedAt
  drep             Drep?
  spo              SPO?
  cc               CC?
  // spoDelegation    Boolean?
  // drepDelegation   Boolean?
  // offchainVotes          OffchainVote[]
}

model Drep { // get drep list from https://api.koios.rest/api/v1/drep_list
  // get drep info from https://api.koios.rest/api/v1/drep_info
  id              String        @id @default(uuid())
  drepId          String        @unique // drep_id value from drep_info api response (CIP-129 format)
  userId          String?       @unique
  name            String?       // meta_json.body.givenName from https://api.koios.rest/api/v1/drep_updates?_drep_id=<drep_id> 
  paymentAddress  String?       // meta_json.body.paymentAddress from https://api.koios.rest/api/v1/drep_updates?_drep_id=<drep_id>
  iconUrl        String?       // meta_json.body.image.contentUrl from https://api.koios.rest/api/v1/drep_updates?_drep_id=<drep_id>
  votingPower     Float   // get from https://api.koios.rest/api/v1/drep_voting_power_history?_epoch_no=320&_drep_id=drep17l6sywnwqu9aedd6aumev42w39ln5zfl9nw7j4ak6u8swyrwvz3 from amount value in response
  createdAt       DateTime?     @default(now())
  updatedAt       DateTime?     @updatedAt
  user            User?         @relation(fields: [userId], references: [id])
  onchainVotes    OnchainVote[]
}

model SPO { // get spo list from https://api.koios.rest/api/v1/pool_list
  // get spo info from https://api.koios.rest/api/v1/pool_info
  id           String        @id @default(uuid())
  poolId       String        @unique  // pool_id_bech32 value from pool_info api response
  userId       String?       @unique
  poolName     String?   // go to meta_url from pool_info api response and use the name value
  ticker       String?  // ticker value from pool_info api response
  iconUrl      String?  // go to meta_url from pool_info api response and go to the url specified under the extended field and look for url_png_icon_64x64 field
  votingPower  Float  // get from https://api.koios.rest/api/v1/pool_voting_power_history?_epoch_no=320&_pool_bech32=pool155efqn9xpcf73pphkk88cmlkdwx4ulkg606tne970qswczg3asc
  createdAt    DateTime?     @default(now())
  updatedAt    DateTime?     @updatedAt
  onchainVotes OnchainVote[]
  user         User?         @relation(fields: [userId], references: [id])
}

model CC { // get cc list from https://api.koios.rest/api/v1/committee_info
  id             String        @id @default(uuid())
  ccId           String        @unique // get members.cc_hot_id value from committee_info api response
  userId         String?       @unique
  memberName     String?  // go to https://api.koios.rest/api/v1/committee_votes?_cc_hot_id=cc_hot1qf5tkz6zwcpplq3kgpt2486d8za943vmymqkdjl249qgw3s2y5r9y and go to meta_url value to get the name value from authors[].name value
  hotCredential  String?  // get members.cc_hot_id value from committee_info api response
  coldCredential String?  // get members.cc_cold_id value from committee_info api response
  status         String?  // get members.expiration_epoch value from committee_info api response and compare with current epoch to get status
  // get epoch_no value from https://api.koios.rest/api/v1/tip to get current epoch
  createdAt      DateTime?     @default(now())
  updatedAt      DateTime?     @updatedAt
  onchainVotes   OnchainVote[]
  user           User?         @relation(fields: [userId], references: [id])
}

enum VoteType {
  YES
  NO
  ABSTAIN
}

enum VoterType {
  DREP
  SPO
  CC
}

enum GovernanceType {
  INFO
  TREASURY
  CONSTITUTION
  HARD_FORK
  PROTOCOL_PARAMETER_CHANGE
  NO_CONFIDENCE
  UPDATE_COMMITTEE
}

enum ProposalStatus {
  ACTIVE
  RATIFIED
  EXPIRED
  APPROVED
  NOT_APPROVED
}

// Ingestion Types

model LastIngestedTime {
  id String @id @default(uuid())
}

// Viewer Types

model Proposal { // get proposals from https://api.koios.rest/api/v1/proposal_list
  id                   Int             @id @default(autoincrement()) 
  proposalId           String          @unique  // proposal_id value from proposal_list api response
  txHash               String  // proposal_tx_hash value from proposal_list api response
  certIndex            String  // proposal_index value from proposal_list api response
  title                String  // meta_json.body.title value from proposal_list api response if its not there, go to meta_url from proposal_list api response and use the body.title value
  description          String?  // meta_json.body.abstract value from proposal_list api response if its not there, go to meta_url from proposal_list api response and use the body.abstract value
  rationale            String?  // meta_json.body.rationale value from proposal_list api response if its not there, go to meta_url from proposal_list api response and use the body.rationale value
  governanceActionType GovernanceType?  // proposal_type value from proposal_list api response 
  status               ProposalStatus  @default(ACTIVE) // look at ratified_epoch, expired_epoch, enacted_epoch and dropped_epoch value from proposal_list api response and compare with current epoch to get status
  submissionEpoch      Int?  // proposed_epoch value from proposal_list api response
  expiryEpoch          Int?  // expired_epoch value from proposal_list api response
  metadata             String?  // meta_json value from proposal_list api response, if not there, go to meta_url from proposal_list api response and use the response body as metadata
  createdAt            DateTime?       @default(now())
  updatedAt            DateTime?       @updatedAt
  onchainVotes         OnchainVote[]
  // offchainVotes   OffchainVote[]

  @@unique([txHash, certIndex])
}

model OnchainVote { // get votes from https://api.koios.rest/api/v1/vote_list
  id             String    @id @default(uuid())
  txHash         String // vote_tx_hash value from vote_list api response
  proposal       Proposal  @relation(fields: [proposalId], references: [proposalId])
  proposalId     String  // proposal_id value from vote_list api response (Cardano governance action ID)
  vote           VoteType? // vote value from vote_list api response
  voterType      VoterType // proposal_type value from vote_list api response
  votingPower    String? 
  // get from https://api.koios.rest/api/v1/pool_voting_power_history?_epoch_no=320&_pool_bech32=pool155efqn9xpcf73pphkk88cmlkdwx4ulkg606tne970qswczg3asc
  // or from https://api.koios.rest/api/v1/drep_voting_power_history?_epoch_no=320&_drep_id=drep17l6sywnwqu9aedd6aumev42w39ln5zfl9nw7j4ak6u8swyrwvz3
  // based on voterType, get the voting power from the appropriate API
  votingPowerAda Float?
  anchorUrl      String?  // meta_url value from vote_list api response
  anchorHash     String?  // meta_hash value from vote_list api response
  votedAt        DateTime? @default(now())  // get block_time value from vote_list api response and convert to DateTime
  createdAt      DateTime? @default(now())  
  updatedAt      DateTime? @updatedAt
  drep           Drep?     @relation(fields: [drepId], references: [drepId])
  drepId         String?  // drep_id in CIP-129 format from vote_list api response
  spo            SPO?      @relation(fields: [spoId], references: [poolId])
  spoId          String?  // pool_id_bech32 from vote_list api response
  cc             CC?       @relation(fields: [ccId], references: [ccId])
  ccId           String?  // cc_hot_id from vote_list api response

  @@unique([proposalId, voterType, drepId, spoId, ccId])
}

// Delegators Engagement Types - To be implemented in future releases

// model OffchainVote {
//   proposal   Proposal  @relation(fields: [proposalId], references: [id])
//   proposalId Int
//   user       User      @relation(fields: [userId], references: [id])
//   userId     String
//   vote       VoteType?
//   createdAt  DateTime? @default(now())
//   updatedAt  DateTime? @updatedAt

//   @@id([proposalId, userId])
// }
